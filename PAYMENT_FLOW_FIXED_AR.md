# ุฅุตูุงุญ ูุณุงุฑ ุงูุฏูุน ูุงูุทูุจุงุช โ

## ุงููุดุงูู ุงูุชู ุชู ุฅุตูุงุญูุง

### ูุจู ุงูุฅุตูุงุญ โ
1. ุงูุทูุจ ูููุดุฃ **ูุจู** ุงูุฏูุน
2. ุฅุฐุง ูุดู ุงูุฏูุนุ ุงูุทูุจ ูุจูู ูู ุงููุธุงู
3. ุงูุทูุจุงุช ุงููุงุดูุฉ ุชุธูุฑ ูู ููุญุฉ ุงูุชุญูู
4. ุงูุนููู ูุฑู ุทูุจุงุช ูู ูุฏูุน ุซูููุง

### ุจุนุฏ ุงูุฅุตูุงุญ โ
1. ุงูุทูุจ ูููุดุฃ ูู **ูุณูุฏุฉ** (draft)
2. ุฅุฐุง ูุฌุญ ุงูุฏูุน โ ุงูุทูุจ ูุชุฃูุฏ
3. ุฅุฐุง ูุดู ุงูุฏูุน โ ุงูุทูุจ ููุญุฐู ุชููุงุฆูุงู
4. ุงูุนููู ูุฑู ููุท ุงูุทูุจุงุช ุงููุคูุฏุฉ

---

## ุงููุณุงุฑ ุงูุฌุฏูุฏ ููุฏูุน

### 1. ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู (COD) ๐ต

```
ุงูุนููู ูุฎุชุงุฑ COD
    โ
ุงูุทูุจ ูููุดุฃ ูุจุงุดุฑุฉ ูู "confirmed"
    โ
ูุธูุฑ ูู ููุญุฉ ุงูุชุญูู
    โ
ุงูุนููู ูุฑุงู ูู ุทูุจุงุชู
```

**ููุงุฐุงุ** ูุฃู COD ูุง ูุญุชุงุฌ ุจูุงุจุฉ ุฏูุน

---

### 2. ุงูุฏูุน ุงูุฅููุชุฑููู (Tap, Tabby, Tamara, etc.) ๐ณ

```
ุงูุนููู ูุฎุชุงุฑ ุทุฑููุฉ ุฏูุน
    โ
ุงูุทูุจ ูููุดุฃ ูู "draft" (ูุณูุฏุฉ)
    โ
ูุญุงููุฉ ุฅูุดุงุก ุนูููุฉ ุฏูุน
    โ
    โโ ูุฌุญ โ ุชูุฌูู ูุจูุงุจุฉ ุงูุฏูุน
    โ         โ
    โ    ุงูุนููู ูุฏูุน
    โ         โ
    โ    โโ ูุฌุญ ุงูุฏูุน โ ุงูุทูุจ ูุชุญูู ูู "confirmed"
    โ    โ                 โ
    โ    โ            ูุธูุฑ ูู ููุญุฉ ุงูุชุญูู
    โ    โ                 โ
    โ    โ            ุงูุนููู ูุฑุงู
    โ    โ
    โ    โโ ูุดู ุงูุฏูุน โ ุงูุทูุจ ููุญุฐู ุชููุงุฆูุงู
    โ
    โโ ูุดู โ ุงูุทูุจ ููุญุฐู ููุฑุงู
              โ
         ุฑุณุงูุฉ ุฎุทุฃ ููุนููู
```

---

## ุงูุชุบููุฑุงุช ุงูุชูููุฉ

### 1. ูู Frontend (`checkout/page.tsx`)

#### ุฃ. ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู:
```typescript
if (selectedPayment === 'cod') {
  // Create confirmed order directly
  const orderResponse = await fetch('/api/orders', {
    body: JSON.stringify({
      ...orderData,
      status: 'confirmed', // โ ูุคูุฏ ูุจุงุดุฑุฉ
    }),
  })
  
  // Clear cart and redirect
  localStorage.removeItem('cart')
  router.push(`/orders/${orderId}?status=success`)
}
```

#### ุจ. ุงูุฏูุน ุงูุฅููุชุฑููู:
```typescript
// 1. Create draft order
const orderResponse = await fetch('/api/orders', {
  body: JSON.stringify({
    ...orderData,
    status: 'draft', // โ ูุณูุฏุฉ
  }),
})

// 2. Try to create payment
const paymentResponse = await fetch('/api/payments/create', {
  body: JSON.stringify({ orderId, provider }),
})

if (!paymentResponse.ok) {
  // โ Payment failed - delete draft order
  await fetch(`/api/orders/${orderId}`, { method: 'DELETE' })
  throw new Error('ูุดู ูู ุฅูุดุงุก ุนูููุฉ ุงูุฏูุน')
}

// โ Redirect to payment gateway
window.location.href = paymentData.paymentUrl
```

---

### 2. ูู Backend (`orderController.ts`)

#### ุฃ. ุฅุฎูุงุก ุงููุณูุฏุงุช ุนู ุงูุนููุงุก:
```typescript
const query = isAdmin 
  ? {} // ุงูุฃุฏูู ูุฑู ูู ุดูุก
  : { userId, status: { $ne: 'draft' } } // ุงูุนููู ูุง ูุฑู ุงููุณูุฏุงุช
```

#### ุจ. ุฅุถุงูุฉ endpoint ููุญุฐู:
```typescript
export const deleteOrder = async (req, res) => {
  // Only allow deleting draft orders
  if (!isAdmin && order.status !== 'draft') {
    return res.status(403).json({ message: 'ูุง ูููู ุญุฐู ุทูุจ ูุคูุฏ' })
  }
  
  await db.collection('Order').deleteOne({ _id: orderId })
}
```

---

### 3. ูู Payment Callback (`paymentController.ts`)

#### ุนูุฏ ูุฌุงุญ ุงูุฏูุน:
```typescript
if (status === 'success') {
  // โ Confirm the order
  await db.collection('Order').updateOne(
    { _id: orderId },
    { 
      $set: { 
        status: 'confirmed',
        paymentStatus: 'paid',
      } 
    }
  )
}
```

#### ุนูุฏ ูุดู ุงูุฏูุน:
```typescript
if (status === 'failed' || status === 'cancelled') {
  // โ Delete the draft order
  await db.collection('Order').deleteOne({ 
    _id: orderId,
    status: 'draft'
  })
}
```

---

## ุญุงูุงุช ุงูุทูุจ (Order Status)

### 1. `draft` (ูุณูุฏุฉ)
- ุงูุทูุจ ุชู ุฅูุดุงุคู ููู ูู ููุฏูุน ุจุนุฏ
- **ูุง ูุธูุฑ** ููุนููู
- **ูุธูุฑ** ููุฃุฏูู (ูููุฑุงูุจุฉ)
- ููุญุฐู ุชููุงุฆูุงู ุฅุฐุง ูุดู ุงูุฏูุน

### 2. `confirmed` (ูุคูุฏ)
- ุงูุทูุจ ุชู ุงูุฏูุน ุจูุฌุงุญ
- **ูุธูุฑ** ููุนููู
- **ูุธูุฑ** ููุฃุฏูู
- ุฌุงูุฒ ูููุนุงูุฌุฉ

### 3. `processing` (ููุฏ ุงููุนุงูุฌุฉ)
- ุงูุฃุฏูู ุจุฏุฃ ุชุฌููุฒ ุงูุทูุจ
- **ูุธูุฑ** ููุนููู
- **ูุธูุฑ** ููุฃุฏูู

### 4. `shipped` (ุชู ุงูุดุญู)
- ุงูุทูุจ ูู ุงูุทุฑูู ููุนููู
- **ูุธูุฑ** ููุนููู
- **ูุธูุฑ** ููุฃุฏูู

### 5. `delivered` (ุชู ุงูุชูุตูู)
- ุงูุทูุจ ูุตู ููุนููู
- **ูุธูุฑ** ููุนููู
- **ูุธูุฑ** ููุฃุฏูู

### 6. `cancelled` (ููุบู)
- ุงูุทูุจ ุชู ุฅูุบุงุคู
- **ูุธูุฑ** ููุนููู
- **ูุธูุฑ** ููุฃุฏูู

---

## ุงูุงุฎุชุจุงุฑ

### ุณููุงุฑูู 1: COD ูุงุฌุญ โ
```
1. ุฃุถู ููุชุฌ ููุณูุฉ
2. ุงุฐูุจ ููุฏูุน
3. ุงุฎุชุฑ "ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู"
4. ุฃููู ุงูุทูุจ

ุงููุชูุฌุฉ:
โ ุงูุทูุจ ูุธูุฑ ููุฑุงู ูู ููุญุฉ ุงูุชุญูู
โ ุงูุทูุจ ูุธูุฑ ูู ุตูุญุฉ ุงูุนููู
โ ุงูุญุงูุฉ: confirmed
```

### ุณููุงุฑูู 2: ุฏูุน ุฅููุชุฑููู ูุงุฌุญ โ
```
1. ุฃุถู ููุชุฌ ููุณูุฉ
2. ุงุฐูุจ ููุฏูุน
3. ุงุฎุชุฑ "ูุฏููุน" (Tap/Tabby/etc)
4. ุฃููู ุงูุฏูุน ูู ุงูุจูุงุจุฉ

ุงููุชูุฌุฉ:
โ ุงูุทูุจ ูุธูุฑ ุจุนุฏ ูุฌุงุญ ุงูุฏูุน
โ ุงูุญุงูุฉ: confirmed
โ ุญุงูุฉ ุงูุฏูุน: paid
```

### ุณููุงุฑูู 3: ุฏูุน ุฅููุชุฑููู ูุงุดู โ
```
1. ุฃุถู ููุชุฌ ููุณูุฉ
2. ุงุฐูุจ ููุฏูุน
3. ุงุฎุชุฑ "ูุฏููุน" (ุจุฏูู ููุงุชูุญ ุตุญูุญุฉ)
4. ุชุธูุฑ ุฑุณุงูุฉ ุฎุทุฃ

ุงููุชูุฌุฉ:
โ ุงูุทูุจ ูุง ูููุดุฃ
โ ูุง ูุธูุฑ ูู ููุญุฉ ุงูุชุญูู
โ ูุง ูุธูุฑ ููุนููู
โ ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ
```

### ุณููุงุฑูู 4: ุฅูุบุงุก ุงูุฏูุน โ
```
1. ุฃุถู ููุชุฌ ููุณูุฉ
2. ุงุฐูุจ ููุฏูุน
3. ุงุฎุชุฑ "ูุฏููุน"
4. ุงุถุบุท "ุฅูุบุงุก" ูู ุจูุงุจุฉ ุงูุฏูุน

ุงููุชูุฌุฉ:
โ ุงูุทูุจ ุงููุณูุฏุฉ ููุญุฐู
โ ูุง ูุธูุฑ ูู ููุญุฉ ุงูุชุญูู
โ ูุง ูุธูุฑ ููุนููู
```

---

## ุฅุตูุงุญ ุทุฑู ุงูุฏูุน

### ุงููุดููุฉ: "ูุดู ูู ุฅูุดุงุก ุนูููุฉ ุงูุฏูุน"

#### ุงูุณุจุจ:
- ุงูููุงุชูุญ ุงูุณุฑูุฉ ุบูุฑ ููุฌูุฏุฉ ุฃู ุฎุงุทุฆุฉ
- ุทุฑููุฉ ุงูุฏูุน ุบูุฑ ููุนูุฉ

#### ุงูุญู:

##### 1. ุชูุนูู COD (ุงูุฃุณูู):
```bash
cd backend
npx ts-node enable-test-payment.ts
```

##### 2. ุฅุถุงูุฉ ููุงุชูุญ ุญููููุฉ:
```
1. ุงุฐูุจ ุฅูู: http://localhost:3000/admin/settings/payment
2. ูุนูู ุทุฑููุฉ ุงูุฏูุน
3. ุฃุฏุฎู ุงูููุงุชูุญ ูู ููุญุฉ ุชุญูู ุงูุจูุงุจุฉ
4. ุงุญูุธ
```

##### 3. ุงูุญุตูู ุนูู ุงูููุงุชูุญ:

**Tap Payment:**
- ุณุฌู ูู: https://tap.company
- Dashboard > API Keys
- ุงูุณุฎ Test Keys

**Tabby:**
- ุณุฌู ูู: https://tabby.ai
- Dashboard > Developers
- ุงูุณุฎ API Keys

**Tamara:**
- ุณุฌู ูู: https://tamara.co
- Dashboard > API
- ุงูุณุฎ Credentials

**MyFatoorah:**
- ุณุฌู ูู: https://myfatoorah.com
- Dashboard > API
- ุงูุณุฎ API Key

---

## ุงููููุงุช ุงููุนุฏูุฉ

### Frontend:
- โ `frontend/src/app/checkout/page.tsx`
  - ุฅุถุงูุฉ ููุทู COD
  - ุฅุถุงูุฉ ุญุฐู ุงููุณูุฏุงุช ุนูุฏ ุงููุดู
  - ุชุญุณูู ูุนุงูุฌุฉ ุงูุฃุฎุทุงุก

### Backend:
- โ `backend/src/controllers/orderController.ts`
  - ุฅุถุงูุฉ `deleteOrder`
  - ุฅุฎูุงุก ุงููุณูุฏุงุช ุนู ุงูุนููุงุก
  - ุฅุถุงูุฉ ุญุงูุฉ `draft`

- โ `backend/src/controllers/paymentController.ts`
  - ุชุฃููุฏ ุงูุทูุจ ุนูุฏ ูุฌุงุญ ุงูุฏูุน
  - ุญุฐู ุงููุณูุฏุฉ ุนูุฏ ูุดู ุงูุฏูุน

- โ `backend/src/routes/orders.ts`
  - ุฅุถุงูุฉ route ููุญุฐู

---

## ุงูููุงุฆุฏ

### ููุนููู:
- โ ูุง ูุฑู ุทูุจุงุช ูุงุดูุฉ
- โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ
- โ ุชุฌุฑุจุฉ ุฃูุถู

### ููุฃุฏูู:
- โ ุทูุจุงุช ูุธููุฉ ููุคูุฏุฉ ููุท
- โ ูุง ุญุงุฌุฉ ูุญุฐู ุงูุทูุจุงุช ุงููุงุดูุฉ ูุฏููุงู
- โ ุฅุฏุงุฑุฉ ุฃุณูู

### ูููุธุงู:
- โ ูุงุนุฏุฉ ุจูุงูุงุช ูุธููุฉ
- โ ูุง ุทูุจุงุช ููููุฉ
- โ ุฃุฏุงุก ุฃูุถู

---

## ููุงุญุธุงุช ูููุฉ

### COD (ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู):
- โ ูุนูู ุฏุงุฆูุงู
- โ ูุง ูุญุชุงุฌ ููุงุชูุญ
- โ ูุซุงูู ููุงุฎุชุจุงุฑ

### ุงูุฏูุน ุงูุฅููุชุฑููู:
- โ๏ธ ูุญุชุงุฌ ููุงุชูุญ ุตุญูุญุฉ
- โ๏ธ ุงุณุชุฎุฏู Test Keys ูู ุงูุชุทููุฑ
- โ๏ธ ุงุณุชุฎุฏู Live Keys ูู ุงูุฅูุชุงุฌ

### ุงููุณูุฏุงุช (Drafts):
- ุชูุญุฐู ุชููุงุฆูุงู ุนูุฏ ุงููุดู
- ูุง ุชุธูุฑ ููุนููุงุก
- ุชุธูุฑ ููุฃุฏูู ูููุฑุงูุจุฉ

---

## ุงูุฎูุงุตุฉ

โ **ุชู ุฅุตูุงุญ ูุณุงุฑ ุงูุฏูุน ุจุงููุงูู**

- ุงูุทูุจุงุช ุงููุงุดูุฉ ูุง ุชูุญูุธ
- COD ูุนูู ุจุดูู ูุซุงูู
- ุงูุฏูุน ุงูุฅููุชุฑููู ูุญูู
- ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู

**ุงููุธุงู ุงูุขู ุงุญุชุฑุงูู ูุฌุงูุฒ ููุฅูุชุงุฌ! ๐**
