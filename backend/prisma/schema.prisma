generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  phone     String?  @unique
  password  String
  name      String
  role      Role     @default(USER)
  orders    Order[]
  addresses Address[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  nameAr          String
  nameEn          String
  tagline         String?
  descriptionAr   String
  descriptionEn   String
  price           Float
  originalPrice   Float?
  brand           String
  category        String
  images          String[]
  colors          String[]
  storage         String[]
  quickFeatures   Json?
  features        Json?
  specifications  Json
  stock           Int
  condition       Condition @default(NEW)
  warranty        String
  rating          Float    @default(0)
  reviewsCount    Int      @default(0)
  orderItems      OrderItem[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Order {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  userId          String      @db.ObjectId
  user            User        @relation(fields: [userId], references: [id])
  items           OrderItem[]
  total           Float
  status          OrderStatus @default(PENDING)
  shippingAddress Json
  paymentMethod   String
  paymentStatus   PaymentStatus @default(PENDING)
  paymentIntentId String?
  transactionId   String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model PaymentIntent {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  orderId       String        @unique
  amount        Float
  currency      String        @default("SAR")
  provider      String
  status        PaymentStatus @default(PENDING)
  paymentUrl    String?
  transactionId String?
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model PaymentSettings {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  provider  String   @unique // tap, myfatoorah, tamara, tabby, cod
  enabled   Boolean  @default(false)
  config    Json     // API keys and other settings
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  orderId   String  @db.ObjectId
  order     Order   @relation(fields: [orderId], references: [id])
  productId String  @db.ObjectId
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Float
}

model Address {
  id         String  @id @default(auto()) @map("_id") @db.ObjectId
  userId     String  @db.ObjectId
  user       User    @relation(fields: [userId], references: [id])
  fullName   String
  phone      String
  city       String
  district   String
  street     String
  building   String
  postalCode String?
  isDefault  Boolean @default(false)
}

enum Role {
  USER
  ADMIN
}

enum Condition {
  NEW
  REFURBISHED
  USED
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

model ShippingProvider {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   @unique // "smsa", "redbox", "aramex"
  displayName String   // "Ø³Ù…Ø³Ø§", "Ø±ÙŠØ¯Ø¨ÙƒØ³", "Ø£Ø±Ø§Ù…ÙƒØ³"
  enabled     Boolean  @default(false)
  apiKey      String?
  apiSecret   String?
  apiUrl      String?
  testMode    Boolean  @default(true)
  settings    Json?    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø®Ø§ØµØ© Ø¨ÙƒÙ„ Ø´Ø±ÙƒØ©
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("shipping_providers")
}

model ShippingRate {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  providerId String   @db.ObjectId
  city       String   // Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
  price      Float    // Ø³Ø¹Ø± Ø§Ù„Ø´Ø­Ù†
  estimatedDays Int    // Ø£ÙŠØ§Ù… Ø§Ù„ØªÙˆØµÙŠÙ„ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("shipping_rates")
}

model Shipment {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId         String   @db.ObjectId
  providerId      String   @db.ObjectId
  trackingNumber  String?
  status          String   // "pending", "picked_up", "in_transit", "delivered", "failed"
  shippingCost    Float
  estimatedDelivery DateTime?
  actualDelivery  DateTime?
  apiResponse     Json?    // Ø§Ø³ØªØ¬Ø§Ø¨Ø© API Ø§Ù„ÙƒØ§Ù…Ù„Ø©
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("shipments")
}

model StoreSettings {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique // "tax_rate", "free_shipping_threshold", etc.
  value     Json     // Ø§Ù„Ù‚ÙŠÙ…Ø©
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("store_settings")
}

// ============================================
// ğŸ­ Distribution Management System
// ============================================

// Ø§Ù„Ø´Ø­Ù†Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ù…Ù† Ø§Ù„Ù…ØµÙ†Ø¹
model FactoryShipment {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  shipmentCode    String   @unique // ÙƒÙˆØ¯ Ø§Ù„Ø´Ø­Ù†Ø©
  model           String   // Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„
  color           String   // Ø§Ù„Ù„ÙˆÙ†
  totalQuantity   Int      // Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ©
  weight          Float?   // Ø§Ù„ÙˆØ²Ù†
  factoryBoxNo    String?  // Ø±Ù‚Ù… Ø§Ù„ÙƒØ±ØªÙˆÙ† Ù…Ù† Ø§Ù„Ù…ØµÙ†Ø¹
  receivedDate    DateTime @default(now())
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("factory_shipments")
}

// Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (ÙƒÙ„ Ø¬Ù‡Ø§Ø² Ù„Ù‡ IMEI)
model Device {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  shipmentId  String   @db.ObjectId
  imei1       String   @unique // IMEI Ø§Ù„Ø£ÙˆÙ„
  imei2       String?  // IMEI Ø§Ù„Ø«Ø§Ù†ÙŠ (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯)
  serialNo    String?  // Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„
  status      DeviceStatus @default(IN_STOCK) // Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²
  groupId     String?  @db.ObjectId // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù„ÙŠ Ø§Ù†Ø¶Ø§Ù Ù„Ù‡Ø§
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("devices")
}

// Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡
model DistributionGroup {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  groupCode     String   @unique // ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ù„Ù„Ù€ QR)
  shipmentId    String   @db.ObjectId
  clientName    String   // Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„
  clientPhone   String?  // Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„
  model         String   // Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„
  color         String   // Ø§Ù„Ù„ÙˆÙ†
  quantity      Int      // Ø§Ù„ÙƒÙ…ÙŠØ©
  qrCode        String?  // QR Code data
  labelPrinted  Boolean  @default(false) // Ù‡Ù„ ØªÙ… Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù„ØµÙ‚
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("distribution_groups")
}

enum DeviceStatus {
  IN_STOCK      // ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
  ASSIGNED      // Ù…Ø®ØµØµ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
  DELIVERED     // ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…
  RETURNED      // Ù…Ø±ØªØ¬Ø¹
}
